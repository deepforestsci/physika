# ============================================================
# Training a Fully Connected Network in Physika
# ============================================================

# ------------------------------------------------------------
# Activation: σ(x) = 1/(1 + e^(-x))
# ------------------------------------------------------------
def sigma(x: ℝ): ℝ:
    return 1.0 / (1.0 + exp(0.0 - x))

# ------------------------------------------------------------
# Network Definition: 2-layer FCN with custom MSE loss
# R[3] -> R[3] -> R[3] -> R
# ------------------------------------------------------------
class FullyConnectedNetwork(f: ℝ → ℝ, W: ℝ[2,3,3], B: ℝ[2,3], w: ℝ[3], b: ℝ, n: ℕ):
    def λ(x: ℝ[3]) → ℝ:
        for k:
            x = f(W[k] @ x + B[k])
        return w @ x + b
    def loss(y: ℝ, target: ℝ) → ℝ:
        return (y - target) ** 2.0


# ------------------------------------------------------------
# Training Data
# ------------------------------------------------------------
X: ℝ[4,3] = [[1.0, 0.0, 0.0],
             [0.0, 1.0, 0.0],
             [0.0, 0.0, 1.0],
             [1.0, 1.0, 1.0]]
y: ℝ[4] = [0.2, 0.4, 0.6, 0.9]

# ------------------------------------------------------------
# Create Network (2 hidden layers)
# ------------------------------------------------------------
W: ℝ[2,3,3] = [[[0.1, 0.2, 0.3], [0.4, 0.5, 0.6], [0.7, 0.8, 0.9]],
               [[0.2, 0.3, 0.4], [0.5, 0.6, 0.7], [0.8, 0.9, 0.1]]]
B: ℝ[2,3] = [[0.1, 0.2, 0.3], [0.1, 0.2, 0.3]]
w: ℝ[3] = [0.5, 0.5, 0.5]
b: ℝ = 0.1

net = FullyConnectedNetwork(sigma, W, B, w, b, 2)

# ------------------------------------------------------------
# Evaluate Before Training (uses class-defined loss)
# ------------------------------------------------------------
loss_before = evaluate(net, X, y)
loss_before

# ------------------------------------------------------------
# Train Network (uses class-defined loss)
# ------------------------------------------------------------
epochs : ℕ = 1000
lr : ℝ = 0.1 
net_trained = train(net, X, y, epochs, lr)

# ------------------------------------------------------------
# Evaluate After Training
# ------------------------------------------------------------
loss_after = evaluate(net_trained, X, y)
loss_after

# ------------------------------------------------------------
# Test Predictions (targets: 0.2, 0.4, 0.6, 0.9)
# ------------------------------------------------------------
net_trained([1.0, 0.0, 0.0])
net_trained([0.0, 1.0, 0.0])
net_trained([0.0, 0.0, 1.0])
net_trained([1.0, 1.0, 1.0])
